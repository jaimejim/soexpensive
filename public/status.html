<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SoExpensive - System Status</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            max-width: 900px;
            margin: 20px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #00ff00;
        }
        h1 {
            border-bottom: 2px solid #00ff00;
            padding-bottom: 10px;
        }
        .test {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #333;
            background: #0a0a0a;
        }
        .test h3 {
            margin-top: 0;
            color: #ffff00;
        }
        .status {
            padding: 5px 10px;
            margin: 5px 0;
            font-weight: bold;
            display: inline-block;
        }
        .status.pending {
            background: #666;
            color: #fff;
        }
        .status.running {
            background: #ff9800;
            color: #000;
        }
        .status.success {
            background: #00ff00;
            color: #000;
        }
        .status.error {
            background: #ff0000;
            color: #fff;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            background: #1a1a1a;
            border-left: 3px solid #00ff00;
            font-size: 12px;
        }
        .error-result {
            border-left-color: #ff0000;
        }
        button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 10px 20px;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            margin: 10px 0;
        }
        button:hover {
            background: #00cc00;
        }
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <h1>╔═══ SOEXPENSIVE SYSTEM STATUS ═══╗</h1>

    <button onclick="runAllTests()">▶ RUN ALL TESTS</button>

    <div class="test">
        <h3>1. Health Endpoint</h3>
        <div class="status pending" id="status1">⏳ Pending</div>
        <div class="result" id="result1" style="display: none;"></div>
    </div>

    <div class="test">
        <h3>2. Seed Endpoint</h3>
        <div class="status pending" id="status2">⏳ Pending</div>
        <div class="result" id="result2" style="display: none;"></div>
    </div>

    <div class="test">
        <h3>3. Stores API</h3>
        <div class="status pending" id="status3">⏳ Pending</div>
        <div class="result" id="result3" style="display: none;"></div>
    </div>

    <div class="test">
        <h3>4. Products API</h3>
        <div class="status pending" id="status4">⏳ Pending</div>
        <div class="result" id="result4" style="display: none;"></div>
    </div>

    <script>
        function updateStatus(testNum, status, message) {
            const statusEl = document.getElementById(`status${testNum}`);
            statusEl.className = `status ${status}`;
            const symbols = { pending: '⏳', running: '⚙', success: '✓', error: '✗' };
            statusEl.textContent = `${symbols[status]} ${message}`;
        }

        function showResult(testNum, content, isError = false) {
            const resultEl = document.getElementById(`result${testNum}`);
            resultEl.style.display = 'block';
            if (isError) resultEl.classList.add('error-result');
            resultEl.innerHTML = `<pre>${content}</pre>`;
        }

        async function test1_Health() {
            updateStatus(1, 'running', 'Checking health...');
            try {
                const response = await fetch('/api/health');
                const data = await response.json();

                if (data.status === 'ok') {
                    updateStatus(1, 'success', 'Health check passed');
                    showResult(1, JSON.stringify(data, null, 2));
                    return data.database?.state;
                } else {
                    throw new Error('Health check failed');
                }
            } catch (error) {
                updateStatus(1, 'error', 'Health check failed');
                showResult(1, `✗ Error: ${error.message}`, true);
                return null;
            }
        }

        async function test2_SeedAvailable() {
            updateStatus(2, 'running', 'Checking seed endpoint...');
            try {
                const response = await fetch('/api/seed', { method: 'HEAD' });
                if (response.status === 405 || response.status === 200) {
                    updateStatus(2, 'success', 'Seed endpoint available');
                    showResult(2, '✓ Seed endpoint is accessible\n✓ Ready to seed database');
                    return true;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                updateStatus(2, 'error', 'Seed endpoint unavailable');
                showResult(2, `✗ Error: ${error.message}\n✗ Check deployment logs`, true);
                return false;
            }
        }

        async function test3_Stores() {
            updateStatus(3, 'running', 'Checking stores...');
            try {
                const response = await fetch('/api/stores');
                const data = await response.json();

                if (Array.isArray(data) && data.length > 0) {
                    updateStatus(3, 'success', `Found ${data.length} stores`);
                    showResult(3, data.map(s => `✓ ${s.name}`).join('\n'));
                    return true;
                } else {
                    updateStatus(3, 'error', 'No stores found - needs seeding');
                    showResult(3, '⚠ Database needs to be seeded\n→ Visit /seed.html', true);
                    return false;
                }
            } catch (error) {
                updateStatus(3, 'error', 'Stores API failed');
                showResult(3, `✗ Error: ${error.message}`, true);
                return false;
            }
        }

        async function test4_Products() {
            updateStatus(4, 'running', 'Checking products...');
            try {
                const response = await fetch('/api/products');
                const data = await response.json();

                if (Array.isArray(data) && data.length > 0) {
                    const categories = [...new Set(data.map(p => p.category))];
                    updateStatus(4, 'success', `Found ${data.length} products`);
                    showResult(4,
                        `✓ Products: ${data.length}\n` +
                        `✓ Categories: ${categories.length}\n` +
                        `✓ Sample:\n  - ${data[0].name} (${data[0].category})\n  - ${data[1]?.name} (${data[1]?.category})`
                    );
                    return true;
                } else {
                    updateStatus(4, 'error', 'No products found - needs seeding');
                    showResult(4, '⚠ Database needs to be seeded\n→ Visit /seed.html', true);
                    return false;
                }
            } catch (error) {
                updateStatus(4, 'error', 'Products API failed');
                showResult(4, `✗ Error: ${error.message}`, true);
                return false;
            }
        }

        async function runAllTests() {
            const dbState = await test1_Health();
            await test2_SeedAvailable();

            if (dbState === 'initialized_empty') {
                console.log('Database empty, skipping data tests');
                updateStatus(3, 'pending', 'Waiting for seed');
                updateStatus(4, 'pending', 'Waiting for seed');
                return;
            }

            await test3_Stores();
            await test4_Products();
        }

        // Auto-run on load
        window.addEventListener('load', () => {
            setTimeout(runAllTests, 500);
        });
    </script>
</body>
</html>
