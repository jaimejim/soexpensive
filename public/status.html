<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Status - It's so expensive</title>
    <link rel="stylesheet" href="reset.css">
    <link rel="stylesheet" href="monospace.css">
    <style>
        body {
            max-width: 80ch;
            padding: 2rem;
        }
        .status-line {
            font-family: 'JetBrains Mono', monospace;
            margin: 0.5rem 0;
        }
        .status-ok::before { content: "[OK] "; }
        .status-error::before { content: "[ERROR] "; }
        .status-checking::before { content: "[...] "; }
    </style>
</head>
<body>
    <h1>System Status</h1>

    <div id="statusList">
        <p class="status-line status-checking">Frontend: Checking...</p>
        <p class="status-line status-checking">API: Checking...</p>
        <p class="status-line status-checking">Database: Checking...</p>
        <p class="status-line status-checking">Data: Checking...</p>
    </div>

    <p style="margin-top: 2rem; color: var(--text-color-alt); font-size: 0.875rem;">
        Last checked: <span id="lastChecked">-</span> â€¢ Auto-refresh: 30s
    </p>

    <script>
        const TIMEOUT = 5000; // 5 seconds

        async function checkStatus() {
            const results = {
                frontend: 'OK',
                api: 'Checking...',
                database: 'Checking...',
                data: 'Checking...'
            };

            // Frontend is OK if this page loaded
            results.frontend = 'OK';

            // Check API and database
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), TIMEOUT);

                const response = await fetch('/api/status', {
                    signal: controller.signal
                });
                clearTimeout(timeoutId);

                if (response.ok) {
                    const data = await response.json();

                    // API status
                    results.api = data.api === 'ok' ? 'OK' : data.api;

                    // Database status
                    if (data.database === 'ok') {
                        results.database = 'OK';
                    } else {
                        results.database = data.database;
                    }

                    // Data status
                    if (data.products !== null && data.stores !== null) {
                        results.data = `${data.products} products, ${data.stores} stores, ${data.prices} prices`;
                    } else {
                        results.data = 'No data - ' + data.database;
                    }

                    // Update last checked time
                    const now = new Date();
                    const hours = String(now.getHours()).padStart(2, '0');
                    const minutes = String(now.getMinutes()).padStart(2, '0');
                    const seconds = String(now.getSeconds()).padStart(2, '0');
                    document.getElementById('lastChecked').textContent = `${hours}:${minutes}:${seconds}`;
                } else {
                    results.api = `HTTP ${response.status}`;
                    results.database = 'API failed';
                    results.data = 'API failed';
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    results.api = 'Timeout after 5s';
                    results.database = 'Timeout';
                    results.data = 'Timeout';
                } else {
                    results.api = error.message;
                    results.database = 'Cannot connect';
                    results.data = 'Cannot connect';
                }
            }

            // Update display
            const statusList = document.getElementById('statusList');
            statusList.innerHTML = `
                <p class="status-line ${results.frontend === 'OK' ? 'status-ok' : 'status-error'}">Frontend: ${results.frontend}</p>
                <p class="status-line ${results.api === 'OK' ? 'status-ok' : 'status-error'}">API: ${results.api}</p>
                <p class="status-line ${results.database === 'OK' ? 'status-ok' : 'status-error'}">Database: ${results.database}</p>
                <p class="status-line ${results.data.includes('products') ? 'status-ok' : 'status-error'}">Data: ${results.data}</p>
            `;
        }

        // Check immediately
        checkStatus();

        // Refresh every 30 seconds
        setInterval(checkStatus, 30000);
    </script>
</body>
</html>
