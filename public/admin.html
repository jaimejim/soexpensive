<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - It's so expensive</title>
    <link rel="stylesheet" href="reset.css">
    <link rel="stylesheet" href="monospace.css">
    <style>
        body {
            max-width: 100ch;
            padding: 1rem;
        }
        h1 {
            margin-bottom: 0.75rem;
        }
        h2 {
            margin-bottom: 0.25rem;
        }
        p {
            margin: 0.25rem 0;
        }
        button {
            padding: 0.4rem 0.8rem;
            margin: 0.3rem 0.3rem 0.3rem 0;
            font-family: 'JetBrains Mono', monospace;
            cursor: pointer;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        #output {
            margin-top: 1rem;
            white-space: pre-wrap;
            font-family: 'JetBrains Mono', monospace;
        }
        .section {
            margin: 1rem 0;
            padding: 0.75rem;
            border: 1px solid var(--text-color-alt);
        }
    </style>
</head>
<body>
    <h1>Site Admin</h1>
    <div style="margin-bottom: 1.5rem; padding: 0.5rem; border: 1px solid var(--text-color-alt); font-size: 0.85rem; color: var(--text-color-alt); display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
        <span><strong>v</strong><span id="commitHash">d5cd739</span></span>
        <span>|</span>
        <a href="/" style="color: var(--text-color); text-decoration: none;">→ Main Site</a>
        <a href="https://github.com/jaimejim/soexpensive" target="_blank" style="color: var(--text-color); text-decoration: none;">→ GitHub</a>
        <span style="margin-left: auto;" id="deployInfo"></span>
    </div>

    <div class="section">
        <h2>1. Diagnostic</h2>
        <p>Check current database state</p>
        <button onclick="checkDuplicates()">Check for Duplicates</button>
    </div>

    <div class="section">
        <h2>2. Cleanup & Reseed</h2>
        <p><strong>Warning:</strong> This will delete all data and reseed from scratch</p>
        <button onclick="cleanup()">Step 1: Clean Database</button>
        <button onclick="seed()" disabled id="seedBtn">Step 2: Seed Database</button>
    </div>

    <div class="section">
        <h2>3. Price Management</h2>
        <p>Fetch or import prices</p>
        <button onclick="fetchPrices()">Fetch from Stores</button>
        <button onclick="importSamplePrices()">Import Sample Prices</button>
    </div>

    <div class="section">
        <h2>4. Health Check</h2>
        <p>Verify API status</p>
        <button onclick="checkHealth()">Check Health</button>
    </div>

    <div id="output"></div>

    <script>
        const output = document.getElementById('output');

        // Fetch deployment info on load
        (async function() {
            try {
                const response = await fetch('/api/health');
                const data = await response.json();
                if (data.timestamp) {
                    const deployTime = new Date(data.timestamp);
                    const timeAgo = Math.round((Date.now() - deployTime) / 1000 / 60);
                    document.getElementById('deployInfo').textContent = `Deployed ${timeAgo}m ago`;
                }
            } catch (e) {
                console.error('Failed to fetch deploy info:', e);
            }
        })();

        function log(message) {
            output.textContent += message + '\n';
        }

        async function checkDuplicates() {
            output.textContent = 'Checking for duplicates...\n';

            try {
                const response = await fetch('/api/products');
                const products = await response.json();

                // Count occurrences of each product name
                const counts = {};
                products.forEach(p => {
                    const key = `${p.name} (${p.category})`;
                    counts[key] = (counts[key] || 0) + 1;
                });

                // Find duplicates
                const duplicates = Object.entries(counts).filter(([_, count]) => count > 1);

                if (duplicates.length === 0) {
                    log('✓ No duplicates found!');
                    log(`Total products: ${products.length}`);
                } else {
                    log(`✗ Found ${duplicates.length} duplicate products:\n`);
                    duplicates.forEach(([name, count]) => {
                        log(`  ${name}: appears ${count} times`);
                    });
                    log(`\nTotal products (including duplicates): ${products.length}`);
                    log(`\nRecommendation: Clean and reseed database`);
                }

            } catch (error) {
                log(`ERROR: ${error.message}`);
            }
        }

        async function cleanup() {
            if (!confirm('This will DELETE ALL DATA. Are you sure?')) {
                return;
            }

            output.textContent = 'Cleaning database...\n';

            try {
                const response = await fetch('/api/cleanup', {
                    method: 'POST'
                });

                const data = await response.json();

                log('=== CLEANUP COMPLETE ===\n');
                log(`Before: ${data.results.before.products} products, ${data.results.before.prices} prices`);
                log(`Deleted: ${data.results.deleted.products} products, ${data.results.deleted.prices} prices`);
                log(`After: ${data.results.after.products} products, ${data.results.after.prices} prices`);
                log('\n✓ Database is now empty');
                log('\nNext: Click "Step 2: Seed Database"');

                // Enable seed button
                document.getElementById('seedBtn').disabled = false;

            } catch (error) {
                log(`ERROR: ${error.message}`);
            }
        }

        async function seed() {
            output.textContent = 'Seeding database...\n';

            // Show timeout warning after 8 seconds
            const timeoutWarning = setTimeout(() => {
                log('Still working... (Vercel has 10s timeout limit)');
            }, 8000);

            try {
                const response = await fetch('/api/seed', {
                    method: 'POST'
                });

                clearTimeout(timeoutWarning);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                // Check if there was an error
                if (!data.success || data.error) {
                    log('=== SEED FAILED ===\n');
                    log(`Error: ${data.error || 'Unknown error'}`);
                    log('\nDebug info:');
                    log(JSON.stringify(data, null, 2));
                    return;
                }

                log('=== SEED COMPLETE ===\n');
                if (data.results) {
                    log(`Stores: ${data.results.stores || 0}`);
                    log(`Products: ${data.results.products || 0}`);
                    log(`Prices: ${data.results.currentPrices || 0}`);
                } else {
                    log('Warning: No results data returned');
                    log('\nFull response:');
                    log(JSON.stringify(data, null, 2));
                }
                log('\n✓ Database seeded successfully!');
                log('\nNext: Check the main site to verify');

                // Disable seed button
                document.getElementById('seedBtn').disabled = true;

            } catch (error) {
                log(`ERROR: ${error.message}`);
            }
        }

        async function fetchPrices() {
            output.textContent = 'Fetching prices from stores...\n';
            log('This may take 1-5 minutes...\n');

            try {
                const response = await fetch('/api/fetch-prices', {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.summary) {
                    log('=== FETCH COMPLETE ===\n');
                    log(`Fetched: ${data.summary.total_fetched || 0} products`);
                    log(`Updated: ${data.summary.total_updated || 0} prices`);
                    log(`Errors: ${data.summary.errors?.length || 0}\n`);

                    // Show debug info
                    if (data.debug) {
                        log('=== DEBUG INFO ===');
                        log(`DB Products: ${data.debug.db_products}`);
                        log(`DB Stores: ${data.debug.db_stores}\n`);

                        // Show store results
                        if (data.stores) {
                            log('Store Results:');
                            Object.entries(data.stores).forEach(([name, info]) => {
                                log(`  ${name}: ${info.status} - ${info.products || 0} scraped, ${info.matched || 0} matched`);
                            });
                            log('');
                        }

                        // Show scraped samples
                        if (data.debug.scraped_samples && Object.keys(data.debug.scraped_samples).length > 0) {
                            log('Scraped Samples (first 3 per store):');
                            Object.entries(data.debug.scraped_samples).forEach(([store, items]) => {
                                log(`  ${store}:`);
                                items.forEach(item => log(`    - ${item.name}: €${item.price}`));
                            });
                            log('');
                        }

                        // Show match samples
                        if (data.debug.match_samples && data.debug.match_samples.length > 0) {
                            log('Match Samples (first 5):');
                            data.debug.match_samples.forEach(m => {
                                log(`  ${m.store}: "${m.scraped_name}" → "${m.matched_to}" (€${m.price_euros} = ${m.price_cents}¢)`);
                            });
                            log('');
                        }
                    }

                    if (data.summary.errors && data.summary.errors.length > 0) {
                        log('Errors:');
                        data.summary.errors.forEach(err => log(`  - ${err}`));
                    }
                } else {
                    log('ERROR: ' + (data.error || 'Unknown error'));
                    if (data.results) {
                        log('\nPartial results:');
                        log(JSON.stringify(data.results, null, 2));
                    }
                }

            } catch (error) {
                log(`ERROR: ${error.message}`);
            }
        }

        async function importSamplePrices() {
            output.textContent = 'Importing sample prices...\n';

            try {
                const sampleResponse = await fetch('/sample-prices.json');
                const sampleData = await sampleResponse.json();

                const response = await fetch('/api/import-prices', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(sampleData)
                });

                const data = await response.json();

                log('=== IMPORT COMPLETE ===\n');
                log(`Total: ${data.total || 0}`);
                log(`Updated: ${data.updated || 0}`);
                log(`Failed: ${data.failed || 0}`);

            } catch (error) {
                log(`ERROR: ${error.message}`);
            }
        }

        async function checkHealth() {
            output.textContent = 'Checking health...\n';

            try {
                const [health, products, stores] = await Promise.all([
                    fetch('/api/health').then(r => r.json()),
                    fetch('/api/products').then(r => r.json()),
                    fetch('/api/stores').then(r => r.json())
                ]);

                log('=== HEALTH CHECK ===\n');
                log(`API: ${health.message || 'OK'}`);
                log(`Products: ${products.length || 0}`);
                log(`Stores: ${stores.length || 0}`);
                log('\n✓ All systems operational');

            } catch (error) {
                log(`ERROR: ${error.message}`);
            }
        }
    </script>
</body>
</html>
